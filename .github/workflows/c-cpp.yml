name: Build OpenWrt TL-WR840N v6.2 (19.07)

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/build-wr840n-v62.yml'
      - '.config'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip \
            zlib1g-dev file wget

      - name: Show CPU/mem
        run: |
          nproc
          free -h
          uname -a

      - name: Prepare .config
        run: |
          cat > .config <<'EOF'
          CONFIG_TARGET_ramips=y
          CONFIG_TARGET_ramips_mt76x8=y
          CONFIG_TARGET_ramips_mt76x8_DEVICE_tl-wr840n-v6.2=y

          CONFIG_TARGET_ROOTFS_SQUASHFS=y
          CONFIG_TARGET_SQUASHFS_BLOCK_SIZE=512

          # Global build settings
          # CONFIG_SIGNED_PACKAGES is not set
          # CONFIG_SIGNATURE_CHECK is not set
          CONFIG_CLEAN_IPKG=y
          # CONFIG_IPV6 is not set
          # CONFIG_KERNEL_IPV6 is not set
          CONFIG_STRIP_KERNEL_EXPORTS=y
          CONFIG_USE_MKLIBS=y
          # CONFIG_KERNEL_DEBUG_FS is not set
          # CONFIG_MAC80211_DEBUGFS is not set
          # CONFIG_KERNEL_KALLSYMS is not set
          # CONFIG_KERNEL_DEBUG_INFO is not set
          CONFIG_KERNEL_SQUASHFS_FRAGMENT_CACHE_SIZE=1
          CONFIG_KERNEL_CC_OPTIMIZE_FOR_SIZE=y
          CONFIG_TARGET_OPTIMIZATION="-Os -pipe -mno-branch-likely -mips32r2 -mtune=24kc"

          # Base system
          # CONFIG_PACKAGE_opkg is not set
          # CONFIG_PACKAGE_openwrt-keyring is not set
          # CONFIG_PACKAGE_libpthread is not set

          # Network
          # CONFIG_PACKAGE_ppp is not set
          # CONFIG_PACKAGE_kmod-ppp is not set

          # Web server
          CONFIG_PACKAGE_uhttpd=y
          CONFIG_PACKAGE_uhttpd-mod-ubus=y

          # LuCI
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-base=y
          CONFIG_PACKAGE_luci-mod-admin-full=y
          CONFIG_PACKAGE_luci-mod-network=y
          CONFIG_PACKAGE_luci-mod-status=y
          CONFIG_PACKAGE_luci-mod-system=y
          CONFIG_PACKAGE_luci-theme-bootstrap=y
          CONFIG_LUCI_SRCDIET=y

          # Wireless + EAP
          CONFIG_PACKAGE_wpad-wolfssl=y
          # CONFIG_PACKAGE_wpad-mini is not set
          # CONFIG_PACKAGE_wpad-basic is not set
          # CONFIG_PACKAGE_wpad-eap is not set
          CONFIG_PACKAGE_ca-certificates=y
          CONFIG_PACKAGE_iwinfo=y
          EOF

      - name: Feeds update/install
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Make defconfig (normalize)
        run: |
          make defconfig
          echo "== Final diffconfig =="
          ./scripts/diffconfig.sh || true

      - name: Build
        env:
          FORCE_UNSAFE_CONFIGURE: "1"
        run: |
          make -j$(nproc) V=s

      - name: Collect artifacts
        if: ${{ always() }}
        run: |
          mkdir -p artifact
          find bin/targets -type f -maxdepth 4 -print0 | xargs -0 -I{} cp "{}" artifact/ || true
          ls -lh artifact || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-wr840n-v6.2-19.07
          path: artifact/*
          if-no-files-found: warn
          retention-days: 14
